import pyxel

class Boss:
    img= 0
    boss_width= 12
    boss_height= 14
    door_width= 10
    door_height= 16
    failures_face_width= 16
    failures_face_height= 16

    def __init__(self):
        # Reference the main app to signal freeze or fail
        #self.app = app_instance
        # Determine the character to punish
        self.__boss_luigi= False
        self.__boss_mario= False
        self.__last_fail= None
        # State when the animation for punishment starts to freeze game
        self.__animation_running= False
        self.__animation_timer= 0
        #Reference for packages
        self.__package= []
        self.__packages_thrown= 0
        self.__is_animating= False
        #The boss knows when mario and luigi rest
        self.__rest_mode= False
        self.__rest_timer= 0
        self.__rest_total= 0

    @property
    def boss_luigi(self):
        return self.__boss_luigi
    @boss_luigi.setter
    def boss_luigi(self, value):
        if isinstance(value, bool):
            self.__boss_luigi= value

    @property
    def boss_mario(self):
        return self.__boss_mario
    @boss_mario.setter
    def boss_mario(self, value):
        if isinstance(value, bool):
            self.__boss_mario= value

    @property
    def last_fail(self):
        return self.__last_fail
    @last_fail.setter
    def last_fail(self, value):
        self.__last_fail= value

    @property
    def animation_running(self):
        return self.__animation_running
    @animation_running.setter
    def animation_running(self, value):
        if isinstance(value, bool):
            self.__animation_running= value

    @property
    def animation_timer(self):
        return self.__animation_timer
    @animation_timer.setter
    def animation_timer(self, value):
        if isinstance(value, int):
            self.__animation_timer= value

    @property
    def package(self):
        return self.__package
    @package.setter
    def package(self, value):
        self.__package= value

    @property
    def packages_thrown(self):
        return self.__packages_thrown
    @packages_thrown.setter
    def packages_thrown(self, value):
        if isinstance(value, int):
            self.__packages_thrown= value

    @property
    def rest_mode(self):
        return self.__rest_mode
    @rest_mode.setter
    def rest_mode(self, value):
        if isinstance(value, bool):
            self.__rest_mode= value

    @property
    def rest_timer(self):
        return self.__rest_timer
    @rest_timer.setter
    def rest_timer(self, value):
        if isinstance(value, int):
            self.__rest_timer= value

    @property
    def rest_total(self):
        return self.__rest_total
    @rest_total.setter
    def rest_total(self, value):
        if isinstance(value, int):
            self.__rest_total= value

    def handle_package_resolution(self, package_obj, is_success):
        """
        Called by App when a single package is completed (thrown or fallen).
        This method updates the lives lost and animation status.
        """
        if not is_success:
            # Determine which side the package fell to set the door flag
            # Note: We rely on the package's final fall position (x) for this
            if package_obj.x < 100:
                self.__last_fail = "luigi"
                self.__boss_luigi = True
                self.__boss_mario = False
            elif package_obj.x > 100:
                self.__last_fail = "mario"
                self.__boss_mario = True
                self.__boss_luigi = False
            # Signal for main to lose a life
            return True
        else:
            # Package was successfully thrown
            self.__packages_thrown += 1
            self.__boss_mario = False
            self.__boss_luigi = False
            return False

    def start_animation(self):
        """Start punishment animation for 5 seconds"""
        self.__animation_running = True
        self.__animation_timer = 300

    def end_animation(self):
        """Handles state changes and time decrements."""
        self.__animation_running = False
        self.__boss_mario = False
        self.__boss_luigi = False
        self.__animation_timer = 0
        self.__last_fail = None

    def start_rest(self, duration):
        """Called by App when Mario and Luigi go to rest
        The boss will appear at the end of this rest period.
        """
        self.__rest_mode = True
        self.__rest_total = duration
        self.__rest_timer = duration

        # In rest mode, we don't want to use the previous punishment animation.
        self.__animation_running = False
        self.__last_fail = None
        self.__boss_mario = False
        self.__boss_luigi = False

    def update(self):
        """Handles state changes and time decrements."""
        if self.__animation_timer > 0:
            self.__animation_timer -= 1
        else:
            self.end_animation()

        if self.__rest_mode:
            if self.__rest_timer > 0:
                self.__rest_timer -= 1

                remaining = self.__rest_timer

                # When there are 60 frames of rest remaining, it is shown
                if remaining <= 60:
                    self.__animation_running = True
                else:
                    self.__animation_running = False
            else:
                self.__rest_mode = False
                self.__animation_running = False

    def draw(self):
        """Draws all the boss animation along with door"""
        #Mario door
        if self.__boss_mario and self.__animation_running:
            pyxel.blt(227, 96, 1, 51, 104, Boss.door_width, Boss.door_height)
        else:
            pyxel.blt(227,96,1,16,104,Boss.door_width,Boss.door_height)
        #Luigi door
        if self.__boss_luigi and self.__animation_running:
            pyxel.blt(3, 128, 1, 35, 104, Boss.door_width, Boss.door_height)
        else:
            pyxel.blt(3,128,1,35,88,Boss.door_width, Boss.door_height)

        if self.__animation_running and self.__last_fail:
            #for luigi
            pyxel.blt(8, 8,1,40,0,Boss.failures_face_width,
                      Boss.failures_face_height)
            if self.__last_fail == "luigi":
                if (pyxel.frame_count // 6) % 2 == 0:
                    pyxel.blt(14,130, Boss.img, 35, 3, Boss.boss_width,
                              Boss.boss_height)
                else:
                    pyxel.blt(14, 130, Boss.img, 35, 18, Boss.boss_width,
                              Boss.boss_height)
            #for mario
            elif self.__last_fail == "mario":
                if (pyxel.frame_count // 6) % 2 == 0:
                    pyxel.blt(212, 98, Boss.img, 33, 35, Boss.boss_width,
                              Boss.boss_height)
                else:
                    pyxel.blt(212, 98, Boss.img, 33, 50, Boss.boss_width,
                              Boss.boss_height)

        elif self.__rest_mode and self.__animation_running:
            if (pyxel.frame_count // 6) % 2 == 0:
                pyxel.blt(212, 98, Boss.img, 33, 35,
                          Boss.boss_width, Boss.boss_height)
            else:
                pyxel.blt(212, 98, Boss.img, 33, 50,
                          Boss.boss_width, Boss.boss_height)
